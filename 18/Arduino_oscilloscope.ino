/*  
    arduino數字示波器  
    作者:�ntwhq@tom.com 
    2013 08 
 */
#include <U8glib.h> //U8g庫頭檔案
U8GLIB_ST7920_128X64_4X u8g(13, 12, 11); // 宣告液晶屏  13=SCLK, 12=SID, 11=CS 
 int Input = A0;  //輸入接腳 
 int Key_add = 8;  //按鈕接腳
 int Key_sub = 9;
 int Key_hold = 10;
 int x,y; //座標
 int i,i1,i2,V_min,V_max,V_mid,t,t0,t1,sta,Key=1,hold=0; 
 long Freq;
 float Vpp;
 int Y[96]; //訊號值儲存陣列
 int Buffer[192]; 
 const uint8_t L[] PROGMEM = {
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x03,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x03,0x70,0x3F,0x87,0xF0,0xC1,0x99,0x83,
0x07,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x07,0x30,0x3F,0xC7,0xF8,0xC1,0x99,0xC3,
0x1F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x06,0x38,0x30,0xC6,0x1C,0xC1,0x99,0xE3,
0x18,0x60,0x00,0x00,0x00,0x00,0x00,0x00,
0x0E,0x18,0x30,0xC6,0x0C,0xC1,0x99,0xF3,
0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00,
0x0F,0xFC,0x3F,0xC6,0x0C,0xC1,0x99,0xBB,
0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00,
0x1F,0xFC,0x3F,0x06,0x0C,0xC1,0x99,0x9F,
0x30,0x30,0x00,0x00,0x00,0x00,0x00,0x00,
0x18,0x0E,0x31,0x86,0x1C,0xE3,0x99,0x8F,
0x38,0x70,0x00,0x00,0x00,0x00,0x00,0x00,
0x38,0x07,0x30,0xC7,0xF8,0x7F,0x19,0x87,
0x1F,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,
0x78,0x07,0xB0,0xE7,0xE0,0x3E,0x19,0x87,
0x07,0x80,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x82,0x00,0x10,
0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x04,0x92,0x00,0x08,
0x00,0x00,0x20,0x40,0x80,0x3E,0x78,0x00,
0x00,0x00,0x00,0x00,0x02,0xA4,0x01,0xFF,
0xE0,0x7F,0xC0,0x40,0x80,0x24,0x88,0x00,
0x00,0x00,0x00,0x00,0x02,0xC4,0x02,0x00,
0x40,0x00,0x00,0x08,0x88,0x24,0x88,0x00,
0x00,0x00,0x00,0x00,0x0F,0xF7,0xE2,0x00,
0x80,0x00,0x00,0x1F,0xF8,0x3C,0x78,0x00,
0x00,0x00,0x00,0x00,0x01,0xCC,0x81,0xFF,
0x80,0x00,0x19,0xA8,0x90,0x26,0xA0,0x00,
0x00,0x00,0x00,0x00,0x02,0xB4,0x80,0x02,
0x03,0xFF,0xE0,0xA8,0x80,0x03,0x14,0x00,
0x00,0x00,0x00,0x00,0x04,0x94,0x80,0x04,
0x00,0x24,0x00,0x27,0xF8,0x7C,0xE8,0x00,
0x00,0x00,0x00,0x00,0x08,0x84,0x80,0x0C,
0x00,0x24,0x80,0x4A,0x10,0x0C,0x40,0x00,
0x00,0x00,0x00,0x00,0x01,0x34,0x87,0xFF,
0xF0,0x44,0x40,0x49,0x20,0x10,0x30,0x00,
0x00,0x00,0x00,0x00,0x07,0xE3,0x00,0x08,
0x00,0x44,0x20,0x49,0x20,0x7E,0xFE,0x00,
0x00,0x1E,0x00,0x00,0x02,0x43,0x00,0x08,
0x00,0x84,0x10,0x88,0xC0,0x22,0x88,0x00,
0x00,0x33,0x00,0x00,0x01,0xC3,0x00,0x08,
0x01,0x04,0x10,0x90,0xC0,0x22,0x88,0x00,
0x00,0x61,0x80,0x00,0x01,0xB4,0x80,0x08,
0x02,0x04,0x00,0x91,0x30,0x22,0x88,0x00,
0x00,0xC0,0x80,0x00,0x02,0x08,0x60,0x38,
0x00,0x1C,0x00,0xA6,0x1C,0x3E,0xF8,0x00,
0x00,0x80,0xC0,0x00,0x04,0x30,0x00,0x10,
0x00,0x08,0x00,0x58,0x00,0x00,0x00,0x00,
0x01,0x80,0x40,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0x80,0x60,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x01,0x00,0x60,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x03,0x00,0x20,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x30,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x02,0x00,0x30,0x00,0x00,0x00,0x00,0x03,
0x00,0x60,0x00,0x20,0x00,0x18,0x00,0x00,
0x06,0x00,0x10,0x00,0x00,0x00,0x00,0x06,
0x00,0x30,0x00,0x60,0x00,0x18,0x00,0x00,
0x06,0x00,0x10,0x00,0x00,0x00,0x00,0x06,
0x00,0x30,0x00,0x60,0x00,0x18,0x00,0x00,
0x04,0x00,0x10,0x00,0x00,0x00,0x00,0x06,
0x1E,0x31,0xBC,0xFE,0x38,0xDB,0xC1,0xD8,
0x04,0x00,0x18,0x00,0x00,0x00,0x00,0x0C,
0x3F,0x19,0xFE,0xFE,0x38,0xDF,0xE3,0xF8,
0x04,0x00,0x18,0x00,0x10,0x00,0x00,0x0C,
0x73,0x19,0xC6,0x63,0x39,0x9C,0x67,0x38,
0x0C,0x00,0x18,0x00,0x18,0x00,0x00,0x0C,
0x60,0x19,0x86,0x63,0x6D,0x98,0x66,0x18,
0x7F,0xFF,0xFF,0xFF,0xFE,0x00,0x00,0x0C,
0x60,0x19,0x86,0x63,0x6D,0x98,0x66,0x18,
0x0C,0x00,0x08,0x00,0x10,0x00,0x00,0x0C,
0x60,0x19,0x86,0x63,0x6D,0x98,0x66,0x18,
0x00,0x00,0x08,0x00,0x30,0x00,0x00,0x0C,
0x73,0x19,0x86,0x61,0xC7,0x18,0x67,0x38,
0x00,0x00,0x0C,0x00,0x30,0x00,0x00,0x0C,
0x3F,0x19,0x86,0x79,0xC7,0x18,0x63,0xF8,
0x00,0x00,0x0C,0x00,0x30,0x00,0x00,0x06,
0x1E,0x31,0x86,0x39,0xC7,0x18,0x61,0xD8,
0x00,0x00,0x04,0x00,0x20,0x00,0x00,0x06,
0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x18,
0x00,0x00,0x04,0x00,0x20,0x00,0x00,0x06,
0x00,0x30,0x00,0x00,0x00,0x00,0x00,0x18,
0x00,0x00,0x06,0x00,0x60,0x00,0x00,0x03,
0x00,0x60,0x00,0x00,0x00,0x00,0x00,0x18,
0x00,0x00,0x06,0x00,0x60,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x02,0x00,0x40,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x03,0x00,0xC0,0x00,0x00,0x00,
0x00,0x00,0x01,0xC7,0x04,0x70,0x38,0xE0,
0x00,0x00,0x03,0x00,0x80,0x00,0x00,0x00,
0x00,0x00,0x02,0x28,0x8C,0x88,0x45,0x10,
0x00,0x00,0x01,0x01,0x80,0x00,0x00,0x00,
0x00,0x00,0x00,0x28,0x94,0x08,0x45,0x10,
0x00,0x00,0x01,0x81,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x48,0x84,0x30,0x44,0xE0,
0x00,0x00,0x00,0xC3,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x88,0x84,0x08,0x45,0x10,
0x00,0x00,0x00,0x66,0x00,0x00,0x00,0x00,
0x00,0x00,0x01,0x08,0x84,0x88,0x45,0x10,
0x00,0x00,0x00,0x3C,0x00,0x00,0x00,0x00,
0x00,0x00,0x03,0xE7,0x04,0x70,0x38,0xE0,
0x00,0x00,0x00,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
}; 

 void sample( )  
{  for(i = 0;i < 192;i++)
   {  
    Buffer[i] = ADCH;
    switch(Key)
     {
       case 1:
       break;
       case 2:
       delayMicroseconds(4);  
       break;
       case 3:
       delayMicroseconds(10);
       break;
       case 4:
       delayMicroseconds(23);
       break;
       case 5:
       delayMicroseconds(60);
       break;
       case 6:
       delayMicroseconds(123); 
       break;
       case 7:
       delayMicroseconds(248);
       break;
       case 8:
       delayMicroseconds(623);
       break;
       case 9:
       delayMicroseconds(1247);
       break;
       default:break;
     }
   }
}

void Measure()
{
  V_max=Buffer[0];
  V_min=Buffer[0];      
  for(i=0;i<192;i++)
  { 
    if(Buffer[i]>V_max) 
    V_max=Buffer[i];
    if(Buffer[i]<V_min) 
    V_min=Buffer[i];
  }
  V_mid=(V_max+V_min)/2;  
  Vpp=(V_max-V_min)*5/255;
  for(i=0;i<97;i++)
  {
    if(Buffer[i]<V_mid&&Buffer[i+1]>=V_mid)  
    {
      i1=i;
      break;
    }
  }
  for(i=i1+1;i<98+i1;i++)
  {
    if(Buffer[i]<V_mid&&Buffer[i+1]>=V_mid)  
    {
      i2=i;
      break;
    }
  }
  t=i2-i1;
  if(t>0)
  Freq=8000/t;
  else
  Freq=0;
}

 void Transform( )  
{ 
  for(sta=0;sta<96;sta++)
  {
    if(Buffer[sta]<128&&Buffer[sta+2]>128)  
    break;
  } 
  for(i = 0;i < 96;i++)  
  Y[i] =  63-(Buffer[i+sta]>>2);     
}

void draw( )  
{  
for(x = 0;x < 95;x++)
  u8g.drawLine(x,Y[x],x,Y[x+1]);  //畫線
 u8g.drawFrame(0,0,97,64);  //畫邊框
 u8g.drawLine(48,0,48,63);  // 畫座標軸
 u8g.drawLine(0,32,96,32);
 for(x=0;x<96;x+=8)
   u8g.drawLine(x,31,x,33);
 for(y=0;y<64;y+=8)
   u8g.drawLine(47,y,49,y);
for(x=8;x<96;x+=8)   //畫網格
 {
    for(y=8;y<64;y+=8)
    u8g.drawPixel(x,y);
 }
//顯示參數 
 u8g.drawStr(98,7,"MS/div");
 u8g.drawStr(98,23,"V/div");
 u8g.drawStr(98,30,"0.625");
 u8g.drawStr(98,40,"Vpp");
 u8g.setPrintPos( 98, 47);
 u8g.print(Vpp);
 u8g.drawStr(118,47,"V");
 u8g.drawStr(98,55,"F(HZ)");
 switch(Key)
 {
      case  1:
      u8g.drawStr(98,14,"0.02");
      u8g.setPrintPos( 98, 62);
      u8g.print(Freq*50);
      break;
      case  2:
      u8g.drawStr(98,14,"0.05");
      u8g.setPrintPos( 98, 62);
      u8g.print(Freq*20);
      break;
      case  3:
      u8g.drawStr(98,14," 0.1");
      u8g.setPrintPos( 98, 62);
      u8g.print(Freq*10);
      break;
      case  4:
      u8g.drawStr(98,14," 0.2");
      u8g.setPrintPos( 98, 62);
      u8g.print(Freq*5);
      break;
      case  5:
      u8g.drawStr(98,14," 0.5");
      u8g.setPrintPos( 98, 62);
      u8g.print(Freq*2);
      break;
     case  6:
      u8g.drawStr(98,14,"  1");
      u8g.setPrintPos( 98, 62);
      u8g.print(Freq);
      break;
     case  7:
      u8g.drawStr(98,14,"  2");
      u8g.setPrintPos( 98, 62);
      u8g.print(Freq/2);
      break;
     case  8:
      u8g.drawStr(98,14,"  5");
      u8g.setPrintPos( 98, 62);
      u8g.print(Freq/5);
      break;
      case  9:
      u8g.drawStr(98,14," 10");
      u8g.setPrintPos( 98, 62);
      u8g.print(Freq/10);
      break;
    default:break;
   }
}

//鍵碟掃描
void Key_scan()
{
    if(digitalRead(Key_add)==LOW) 
	{
	  while(digitalRead(Key_add)==LOW);
	  Key++;
	  if(Key==10)
	  Key=9;
	  delay(10);
	}
	if(digitalRead(Key_sub)==LOW) 
	{
	  while(digitalRead(Key_sub)==LOW);
	  Key--;
	  if(Key==0)
	  Key=1;
	  delay(10);
        }
        if(digitalRead(Key_hold)==LOW) 
	{
	  while(digitalRead(Key_hold)==LOW);
          hold=~hold;
	  delay(10);
        }
}

 void setup( ) 
 { 
   pinMode(Key_add,INPUT_PULLUP);
   pinMode(Key_sub,INPUT_PULLUP);
   pinMode(Key_hold,INPUT_PULLUP);
   ADMUX=0x60;  
   ADCSRA=0xe2; 
   u8g.setFont(u8g_font_5x7); 
    u8g.firstPage();  
   do {
        u8g.drawBitmapP( 0, 0, 16, 64, L); 
      } 
   while( u8g.nextPage() );
   delay(2000); 
 } 
 
void loop( ) 
 { 
   sample( );
   Measure( ); 
   Transform( );
   Key_scan( );
   if(hold==0)
   {
     u8g.firstPage( );  
     do
     {
       draw( ); 
     }
     while( u8g.nextPage( ));
   }
 } 
 
 

 

